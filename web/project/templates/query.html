{% extends "base.html" %}

{% set curSide = "查询" %}

{% block head %}



{% endblock %}

{% block content %}

    {% if 'user' in ses  %}

        <div class="mdui-typo">
            <h1 class="mdui-text-color-theme">查询</h1>

            <p>This is the query page.</p>

            <p>Tickets from <code>北京</code> to <code>上海</code></p>

        </div>
        <div>

            <div>
                <div style="margin: 20px 0"></div>
                <div style="display: inline-block">
                    出发地：
                    <select id="fromInput" style="width: 150px;" class="slt">
                    </select>
                </div>

                <div style="display: inline-block; margin: 0 20px">
                    目的地：
                    <select id="toInput" style="width: 150px;" class="slt">
                    </select>
                </div>

                <div style="display: inline-block; margin: 0 20px">
                    日期：
                    <select id="dateInput" style="width: 150px;">
                    </select>
                </div>

                <div style="display: inline-block">
                    <label class="mdui-switch">
                        <input type="checkbox" id="viaCheck"/>
                        <i class="mdui-switch-icon" style="margin-right: 5px"></i>
                        查询中转
                    </label>
                </div>

                <div style="margin-top: 20px" id="catas">
                    类别：
                </div>

                <div align="center" style="margin: 20px 0">
                    <button class="mdui-btn mdui-ripple mdui-color-theme-accent" id="profilebtn" onclick="submitQuery()">查询</button>
                </div>

            </div>


            <div class="mdui-table-fluid" style="visibility: hidden" id="tableCon">
                <table class="mdui-table mdui-table-hoverable" id="tablePlace">
                </table>
            </div>

            <div>
                {#                <div align="center"> 查询结果 </div>#}
                <div class="mdui-panel mdui-panel-popout" id="panelPlace" mdui-panel="{accordion: true}" style="visibility: hidden">

                </div>
            </div>




        </div>

    {% else %}
        <div class="mdui-typo">
            please login...
        </div>
    {% endif %}

{% endblock %}

{% block app %}

    <div class="mdui-dialog" id="detailDialogue">
        <div class="mdui-dialog-title">DETAIL</div>
        <div class="mdui-dialog-content" id="detailMsg">

        </div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-close id="detailCancleBtn">cancel</button>
        </div>
    </div>

{% endblock %}

{% block scr %}

    <script src="{{ url_for('static', filename='js/pinyin4js.js') }}"></script>
    <script>

        {#console.log()#}

        $(document).ready(function () {
            for (var i = 1; i <= 30; i++) {
                $('#dateInput').append('<option>2019-06-' + (i < 10 ? '0' : '') + i + '</option>')
            }
            for (var i = 0; i < allCity.length; i++) {
                $('.slt').append('<option>' + allCity[i] + '</option>')
            }
            $('#fromInput').editableSelect( {
                effects: 'slide'
            });
            $('#toInput').editableSelect({
                effects: 'slide'
            })
            $('#dateInput').editableSelect({
                effects: 'slide'
            })
        })

        function createTable() {
            var tbl = $('#tablePlace')
            tbl.html('')
            var hd = $('<thead></thead>')
            var hr = $('<tr></tr>')
            $('<th> # </th>').appendTo(hr)
            for (var j = 0; j < 8; j++) {
                if (j == 2 || j == 5) continue
                var cu = $('<th>'+tagname[j]+'</th>')
                cu.appendTo(hr)
            }
            $('<th></th>').appendTo(hr)
            hr.appendTo(hd)
            hd.appendTo(tbl)
            var bd = $('<tbody></tbody>')
            for (var i = 0; i < data.length; i++) {
                var r = $('<tr></tr>')
                $('<td>'+(i+1)+'</td>').appendTo(r)
                for (var j = 0; j < 7; j++) {
                    if (j == 2 || j == 5) continue
                    if (j == 6 && data[i][5] != data[i][2]) {
                        var cu = $('<td><span style="color:#ff0000">[次日]</span>' + data[i][j] + '</td>')
                        cu.appendTo(r)
                    } else {
                        var cu = $('<td>' + data[i][j] + '</td>')
                        cu.appendTo(r)
                    }
                }
                var flag = 0;
                var pri = 1e18;
                for (var k = 0; k < data[i][7].length; k++) {
                    if (data[i][7][k][1] > 0) {
                        flag = 1;
                        if (data[i][7][k][2] < pri) {
                            pri = data[i][7][k][2]
                        }
                    }
                }
                $('<td>'+(flag!=0?'有，￥' + pri.toFixed(2) + '起':'无')+'</td>').appendTo(r)
                $('<td><button class="mdui-btn mdui-btn-raised mdui-ripple" onclick="clickedAtRow('+i+')">详情</button></td>').appendTo(r)
                r.appendTo(bd)
            }
            bd.appendTo(tbl)
            $('#tableCon').css('visibility', 'visible')
        }

        var detailDialog = new mdui.Dialog('#detailDialogue');

        function clickedAtRow(x) {
            var tx = document.createElement('div')
            tx.setAttribute('class', 'mdui-typo')
            var len = data[x][7].length
            for(var i=0;i<len;i++) {
                tx.innerHTML += "<h1 class='mdui-text-color-theme' style='display: inline;'>" + data[x][7][i][0] + "</h1>"
                tx.innerHTML += "<p style='display: inline;'>" + ": 余" + data[x][7][i][1] + "张" + "</p>"
                tx.innerHTML += "<p style='display: inline;'>" + "，￥" + data[x][7][i][2] + "</p> <br/>"
            }
            document.querySelector('#detailMsg').innerHTML = ""
            document.querySelector('#detailMsg').append(tx)

            detailDialog.open()
            document.querySelector('#detailCancleBtn').focus()
            // alert(row)
        }

        function submitQuery() {
            var cmd = ''
            if ($('#viaCheck').prop('checked') == true) {
                cmd = 'query_transfer'
            } else {
                cmd = 'query_ticket'
            }
            cmd += ' '
            cmd += $('#fromInput').val()
            cmd += ' '
            cmd += $('#toInput').val()
            cmd += ' '
            cmd += $('#dateInput').val()
            cmd += ' '
            for (var i = 0; i < allCata.length; i++) {
                if ($('#cataCKB' + i).prop('checked') == true) {
                    cmd += allCata[i]
                }
            }
            {#alert(cmd)#}
            console.log(cmd)

            execCommand(cmd, function (d) {
                handleQueryTicket(d.result)
            })

        }

        function handleQueryTicket(ret) {
            data = []
            ar = ret.split(/[ ]|\n/)
            console.log(ar)
            var cu = 1, cnt = parseInt(ar[0]);
            for (var i = 0; i < cnt; i++) {
                var curTr = []
                curTr.push(ar[cu])
                curTr.push(ar[cu + 1])
                curTr.push(ar[cu + 2])
                curTr.push(ar[cu + 3])
                curTr.push(ar[cu + 4])
                curTr.push(ar[cu + 5])
                curTr.push(ar[cu + 6])
                cu = cu + 7;
                curTr.push([])
                let l = curTr.length
                while (/.*[\u4e00-\u9fa5]+.*/.test(ar[cu])) {
                    curTr[l - 1].push([ar[cu], parseInt(ar[cu + 1]), parseFloat(parseFloat(ar[cu + 2]).toFixed(2))])
                    cu = cu + 3
                }
                curTr.push('orz')
                curTr.push('TTK')
                data.push(curTr)
            }
            createPanel()
            createTable()
        }

        for (var i = 0; i < allCata.length; i++) {
            $('#catas').append('<label class="mdui-checkbox" style="margin-right:50px"><input type="checkbox" id="cataCKB' + i + '" checked/><i class="mdui-checkbox-icon"></i>' + allCata[i] + '</label>')
        }

    </script>

{% endblock %}